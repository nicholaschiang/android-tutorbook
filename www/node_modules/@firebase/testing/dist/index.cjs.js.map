{"version":3,"file":"index.cjs.js","sources":["../src/api/index.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2018 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as firebase from 'firebase';\nimport * as request from 'request';\nimport { base64 } from '@firebase/util';\nimport { setLogLevel, LogLevel } from '@firebase/logger';\nimport * as grpc from 'grpc';\nimport * as protoLoader from '@grpc/proto-loader';\nimport { resolve } from 'path';\n\nexport { database, firestore } from 'firebase';\n\nconst PROTO_ROOT = resolve(\n  __dirname,\n  process.env.FIRESTORE_EMULATOR_PROTO_ROOT || '../protos'\n);\nconst PROTO_FILE = resolve(\n  PROTO_ROOT,\n  'google/firestore/emulator/v1/firestore_emulator.proto'\n);\nconst PKG_DEF = protoLoader.loadSync(PROTO_FILE, { includeDirs: [PROTO_ROOT] });\nconst PROTOS = grpc.loadPackageDefinition(PKG_DEF);\nconst EMULATOR = (PROTOS['google'] as any)['firestore']['emulator']['v1'];\n\n/** If this environment variable is set, use it for the database emulator's address. */\nconst DATABASE_ADDRESS_ENV: string = 'FIREBASE_DATABASE_EMULATOR_ADDRESS';\n/** The default address for the local database emulator. */\nconst DATABASE_ADDRESS_DEFAULT: string = 'localhost:9000';\n/** The actual address for the database emulator */\nconst DATABASE_ADDRESS: string =\n  process.env[DATABASE_ADDRESS_ENV] || DATABASE_ADDRESS_DEFAULT;\n\n/** If any of environment variable is set, use it for the Firestore emulator. */\nconst FIRESTORE_ADDRESS_ENVS: string[] = [\n  'FIRESTORE_EMULATOR_HOST',\n  'FIREBASE_FIRESTORE_EMULATOR_ADDRESS'\n];\n/** The default address for the local Firestore emulator. */\nconst FIRESTORE_ADDRESS_DEFAULT: string = 'localhost:8080';\n/** The actual address for the Firestore emulator */\nconst FIRESTORE_ADDRESS: string = FIRESTORE_ADDRESS_ENVS.reduce(\n  (addr, name) => process.env[name] || addr,\n  FIRESTORE_ADDRESS_DEFAULT\n);\n\n/** Passing this in tells the emulator to treat you as an admin. */\nconst ADMIN_TOKEN = 'owner';\n/** Create an unsecured JWT for the given auth payload. See https://tools.ietf.org/html/rfc7519#section-6. */\nfunction createUnsecuredJwt(auth: object): string {\n  // Unsecured JWTs use \"none\" as the algorithm.\n  const header = {\n    alg: 'none',\n    kid: 'fakekid'\n  };\n  // Ensure that the auth payload has a value for 'iat'.\n  (auth as any).iat = (auth as any).iat || 0;\n  // Use `uid` field as a backup when `sub` is missing.\n  (auth as any).sub = (auth as any).sub || (auth as any).uid;\n  if (!(auth as any).sub) {\n    throw new Error(\"auth must be an object with a 'sub' or 'uid' field\");\n  }\n  // Unsecured JWTs use the empty string as a signature.\n  const signature = '';\n  return [\n    base64.encodeString(JSON.stringify(header), /*webSafe=*/ false),\n    base64.encodeString(JSON.stringify(auth), /*webSafe=*/ false),\n    signature\n  ].join('.');\n}\n\nexport function apps(): firebase.app.App[] {\n  return firebase.apps;\n}\n\nexport type AppOptions = {\n  databaseName?: string;\n  projectId?: string;\n  auth?: object;\n};\n/** Construct an App authenticated with options.auth. */\nexport function initializeTestApp(options: AppOptions): firebase.app.App {\n  return initializeApp(\n    options.auth ? createUnsecuredJwt(options.auth) : undefined,\n    options.databaseName,\n    options.projectId\n  );\n}\n\nexport type AdminAppOptions = {\n  databaseName?: string;\n  projectId?: string;\n};\n/** Construct an App authenticated as an admin user. */\nexport function initializeAdminApp(options: AdminAppOptions): firebase.app.App {\n  return initializeApp(ADMIN_TOKEN, options.databaseName, options.projectId);\n}\n\nfunction initializeApp(\n  accessToken?: string,\n  databaseName?: string,\n  projectId?: string\n): firebase.app.App {\n  let appOptions: { [key: string]: string } = {};\n  if (databaseName) {\n    appOptions['databaseURL'] = `http://${DATABASE_ADDRESS}?ns=${databaseName}`;\n  }\n  if (projectId) {\n    appOptions['projectId'] = projectId;\n  }\n  const appName = 'app-' + new Date().getTime() + '-' + Math.random();\n  let app = firebase.initializeApp(appOptions, appName);\n  // hijacking INTERNAL.getToken to bypass FirebaseAuth and allows specifying of auth headers\n  if (accessToken) {\n    (app as any).INTERNAL.getToken = () =>\n      Promise.resolve({ accessToken: accessToken });\n  }\n  if (databaseName) {\n    // Toggle network connectivity to force a reauthentication attempt.\n    // This mitigates a minor race condition where the client can send the\n    // first database request before authenticating.\n    app.database().goOffline();\n    app.database().goOnline();\n  }\n  if (projectId) {\n    app.firestore().settings({\n      host: FIRESTORE_ADDRESS,\n      ssl: false\n    });\n  }\n  /**\n  Mute warnings for the previously-created database and whatever other\n  objects were just created.\n */\n  setLogLevel(LogLevel.ERROR);\n  return app;\n}\n\nexport type LoadDatabaseRulesOptions = {\n  databaseName: string;\n  rules: string;\n};\nexport function loadDatabaseRules(\n  options: LoadDatabaseRulesOptions\n): Promise<void> {\n  if (!options.databaseName) {\n    throw Error('databaseName not specified');\n  }\n\n  if (!options.rules) {\n    throw Error('must provide rules to loadDatabaseRules');\n  }\n\n  return new Promise((resolve, reject) => {\n    request.put(\n      {\n        uri: `http://${DATABASE_ADDRESS}/.settings/rules.json?ns=${options.databaseName}`,\n        headers: { Authorization: 'Bearer owner' },\n        body: options.rules\n      },\n      (err, resp, body) => {\n        if (err) {\n          reject(err);\n        } else if (resp.statusCode !== 200) {\n          reject(JSON.parse(body).error);\n        } else {\n          resolve();\n        }\n      }\n    );\n  });\n}\n\nexport type LoadFirestoreRulesOptions = {\n  projectId: string;\n  rules: string;\n};\nexport function loadFirestoreRules(\n  options: LoadFirestoreRulesOptions\n): Promise<void> {\n  if (!options.projectId) {\n    throw new Error('projectId not specified');\n  }\n\n  if (!options.rules) {\n    throw new Error('must provide rules to loadFirestoreRules');\n  }\n\n  let client = new EMULATOR.FirestoreEmulator(\n    FIRESTORE_ADDRESS,\n    grpc.credentials.createInsecure()\n  );\n  return new Promise((resolve, reject) => {\n    client.setSecurityRules(\n      {\n        project: `projects/${options.projectId}`,\n        rules: { files: [{ content: options.rules }] }\n      },\n      // @ts-ignore Defined in protobuf.\n      (err: Error, resp) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(resp);\n        }\n      }\n    );\n  });\n}\n\nexport type ClearFirestoreDataOptions = {\n  projectId: string;\n};\nexport function clearFirestoreData(\n  options: ClearFirestoreDataOptions\n): Promise<void> {\n  if (!options.projectId) {\n    throw new Error('projectId not specified');\n  }\n\n  let client = new EMULATOR.FirestoreEmulator(\n    FIRESTORE_ADDRESS,\n    grpc.credentials.createInsecure(),\n    {\n      // As with 'loadFirestoreRules', cap how much backoff gRPC will perform.\n      'grpc.initial_reconnect_backoff_ms': 100,\n      'grpc.max_reconnect_backoff_ms': 100\n    }\n  );\n  return new Promise((resolve, reject) => {\n    client.clearData(\n      {\n        database: `projects/${options.projectId}/databases/(default)`\n      },\n      // @ts-ignore Defined in protobuf.\n      (err: Error, resp) => {\n        if (err) {\n          reject(err);\n        } else {\n          resolve(resp);\n        }\n      }\n    );\n  });\n}\n\nexport function assertFails(pr: Promise<any>): any {\n  return pr.then(\n    v =>\n      Promise.reject(new Error('Expected request to fail, but it succeeded.')),\n    err => err\n  );\n}\n\nexport function assertSucceeds(pr: Promise<any>): any {\n  return pr;\n}\n"],"names":["resolve","protoLoader.loadSync","grpc.loadPackageDefinition","base64","firebase.apps","firebase.initializeApp","setLogLevel","LogLevel","request.put","grpc.credentials"],"mappings":"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"}